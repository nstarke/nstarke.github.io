<!DOCTYPE html>
<html>
<head>
<title>0042-netgear-bootloader-analysis-part-2.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="netgear-bootloader-analysis-part-2">Netgear Bootloader Analysis: Part 2</h1>
<p>Published: January 20, 2021</p>
<p>This is the second part of my analysis on the bootloader for the Netgear Nighthawk R9000 (x10) router.</p>
<h2 id="static-comparison">Static Comparison</h2>
<p>In order to better understand the structure of the Netgear Bootloader and to have a point of reference, I compiled a similar U-Boot image using the <code>Bananapi</code> board as a reference board.  This will not result in parity to the Anna Purna Labs Alpine board that the Netgear router runs on, but it will be close enough to confirm a few things.</p>
<p>First things first though, compiling the <code>v2015.01</code> tag/version of U-Boot was not simple on a modern distribution; it required installing <code>gcc-4.9-arm-linux-gnueabihf</code> which hasn't been available via apt since Ubuntu Vivid.  To easily install this version of the GCC cross compiler via apt, I ran this command:</p>
<pre class="hljs"><code><div>$ echo &quot;deb http://old-releases.ubuntu.com/ubuntu vivid main&quot; | sudo tee /etc/apt/sources.list.d/vivid.list
$ sudo apt update
$ sudo apt install gcc-4.9-arm-linux-gnueabihf
</div></code></pre>
<p>Then I linked the binary into place:</p>
<pre class="hljs"><code><div>$ sudo ln -s /usr/bin/arm-linux-gnueabihf-gcc-4.9 /usr/bin/arm-linux-gnueabihf-gcc
</div></code></pre>
<p>Sym linking the binary is not the preferred method; using <code>update-alternatives</code> is a much better approach.</p>
<p>I needed a few dependencies to build u-boot:</p>
<pre class="hljs"><code><div>$ sudo apt install python-dev python3-dev flex bison build-essential
</div></code></pre>
<p>There may be other dependencies that I had installed previous to this work that I might be missing.</p>
<p>Then to compile u-boot:</p>
<pre class="hljs"><code><div>$ git clone https://github.com/u-boot/u-boot.git
$ git checkout v2015.01
$ ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- make Bananapi_defconfig
$ ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- make
</div></code></pre>
<p>At the end of the compilation process, a few binaries should be dropped on the filesystem.</p>
<pre class="hljs"><code><div>$ file {u-boot,u-boot.bin}
u-boot:     ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), dynamically linked, interpreter /usr/lib/ld.so.1, with debug_info, not stripped
u-boot.bin: COM executable for DOS
</div></code></pre>
<p>The second file, <code>u-boot.bin</code>, is the primary file I used for comparison.  This file is stripped of all symbols, as opposed to the <code>u-boot</code> file which has a valid elf header and debug symbols.  I used it for a few comparison tasks.</p>
<p>The next step is to load <code>u-boot.bin</code> into Ghidra.  I needed to know the load address for the Bananapi board, which I found by grepping for the config key <code>CONFIG_SYS_TEXT_BASE</code> in <code>./spl/include/autoconf.mk</code>:</p>
<pre class="hljs"><code><div>$ grep CONFIG_SYS_TEXT_BASE ./spl/include/autoconf.mk
CONFIG_SYS_TEXT_BASE=0x4a000000
</div></code></pre>
<p>This told me the load address is <code>0x4a000000</code>. Using this value, I load the binary into Ghidra.</p>
<p>One of the first things I was struck by was a similarity in the first few bytes of the <code>u-boot.bin</code> file.  After the first four bytes, which is a branch instruction, there are seven double words with the same value <code>0xE59FF014</code>. This is the same pattern as in the carved out Netgear bootloader.</p>
<p><strong>BananaPi:</strong></p>
<pre class="hljs"><code><div>                             //
                             // ram 
                             // ram:4a000000-ram:4a04df9f
                             //
             assume spsr = 0x0  (Default)
                             LAB_4a000000                                    XREF[6]:     FUN_4a0002c0:4a000314(*), 
                                                                                          4a000378(*), 
                                                                                          FUN_4a000d64:4a000e20(R), 
                                                                                          4a000e64(*), 4a003c30(*), 
                                                                                          4a003fe4(*)  
        4a000000 b8 00 00 ea     b          LAB_4a0002e8
                             DAT_4a000004                                    XREF[1]:     FUN_4a000d64:4a000e20(R)  
        4a000004 14 f0 9f e5     undefined4 E59FF014h
                             DAT_4a000008                                    XREF[1]:     FUN_4a000d64:4a000e20(R)  
        4a000008 14 f0 9f e5     undefined4 E59FF014h
                             DAT_4a00000c                                    XREF[1]:     FUN_4a000d64:4a000e20(R)  
        4a00000c 14 f0 9f e5     undefined4 E59FF014h
        4a000010 14 f0 9f e5     ddw        E59FF014h
        4a000014 14 f0 9f e5     ddw        E59FF014h
        4a000018 14 f0 9f e5     ddw        E59FF014h
        4a00001c 14 f0 9f e5     ddw        E59FF014h

</div></code></pre>
<p><strong>Netgear:</strong></p>
<pre class="hljs"><code><div>                             //
                             // ram 
                             // ram:00100000-ram:0016df0f
                             //
             assume spsr = 0x0  (Default)
                             LAB_00100000                                    XREF[8]:     0010032c(*), 00100384(*), 
                                                                                          FUN_00100494:00100570(R), 
                                                                                          001005cc(*), 0010313a(*), 
                                                                                          FUN_00105d4c:00105d74(*), 
                                                                                          00113578(*), 0011384c(*)  
        00100000 be 00 00 ea     b          LAB_00100300
                             DAT_00100004                                    XREF[1]:     FUN_00100494:00100570(R)  
        00100004 14 f0 9f e5     undefined4 E59FF014h
                             DAT_00100008                                    XREF[1]:     FUN_00100494:00100570(R)  
        00100008 14 f0 9f e5     undefined4 E59FF014h
                             DAT_0010000c                                    XREF[1]:     FUN_00100494:00100570(R)  
        0010000c 14 f0 9f e5     undefined4 E59FF014h
                             LAB_00100010                                    XREF[4]:     00138e58(*), 00139758(*), 
                                                                                          0013975c(*), 00139760(*)  
        00100010 14 f0 9f e5     ldr        pc,[LAB_0010002c]
                             DWORD_00100014+1                                XREF[0,1]:   0013978c(*)  
        00100014 14 f0 9f e5     ddw        E59FF014h
        00100018 14 f0 9f e5     ddw        E59FF014h
        0010001c 14 f0 9f e5     ddw        E59FF014h

</div></code></pre>
<p>This leads me to understand that I did figure out the correct file offset for the Netgear image and that I have the base load address correct for the Netgear image.</p>
<p>In the opcode located in the first four bytes, the BananaPi image branches to address <code>0x4a0002e8</code> while the Netgear image branches to address <code>00100300</code>.  Looking at the function at these addresses, they are very similar in both images:</p>
<p><strong>BananaPi:</strong></p>
<pre class="hljs"><code><div>                             LAB_4a0002e8                                    XREF[1]:     4a000000(j)  
        4a0002e8 12 00 00 eb     bl         FUN_4a000338                                     undefined FUN_4a000338()
        4a0002ec 00 00 0f e1     mrs        r0,cpsr
        4a0002f0 1f 10 00 e2     and        r1,r0,#0x1f
        4a0002f4 1a 00 31 e3     teq        r1,#0x1a
        4a0002f8 1f 00 c0 13     bicne      r0,r0,#0x1f
        4a0002fc 13 00 80 13     orrne      r0,r0,#0x13
        4a000300 c0 00 80 e3     orr        r0,r0,#0xc0
        4a000304 00 f0 29 e1     msr        cpsr_cf,r0
        4a000308 10 0f 11 ee     mrc        p15,0x0,r0,cr1,cr0,0x0
        4a00030c 02 0a c0 e3     bic        r0,r0,#0x2000
        4a000310 10 0f 01 ee     mcr        p15,0x0,r0,cr1,cr0,0x0
        4a000314 5c 00 9f e5     ldr        r0=&gt;LAB_4a000000,[PTR_LAB_4a000378]              = 4a000000
        4a000318 10 0f 0c ee     mcr        p15,0x0,r0,cr12,cr0,0x0
        4a00031c 06 00 00 eb     bl         FUN_4a00033c                                     undefined FUN_4a00033c()
        4a000320 13 00 00 eb     bl         thunk_FUN_4a00037c                               undefined thunk_FUN_4a00037c()
        4a000324 8e 02 00 eb     bl         FUN_4a000d64                                     undefined FUN_4a000d64()
        4a000328 15 0f 07 ee     mcr        p15,0x0,r0,cr7,cr5,0x0
        4a00032c 9a 0f 07 ee     mcr        p15,0x0,r0,cr7,cr10,0x4
        4a000330 95 0f 07 ee     mcr        p15,0x0,r0,cr7,cr5,0x4
        4a000334 1e ff 2f e1     bx         lr
</div></code></pre>
<p><strong>Netgear:</strong></p>
<pre class="hljs"><code><div>                             LAB_00100300                                    XREF[1]:     00100000(j)  
        00100300 10 00 00 eb     bl         FUN_00100348                                     undefined FUN_00100348()
        00100304 00 00 0f e1     mrs        r0,cpsr
        00100308 1f 10 00 e2     and        r1,r0,#0x1f
        0010030c 1a 00 31 e3     teq        r1,#0x1a
        00100310 1f 00 c0 13     bicne      r0,r0,#0x1f
        00100314 13 00 80 13     orrne      r0,r0,#0x13
        00100318 c0 00 80 e3     orr        r0,r0,#0xc0
        0010031c 00 f0 29 e1     msr        cpsr_cf,r0
        00100320 10 0f 11 ee     mrc        p15,0x0,r0,cr1,cr0,0x0
        00100324 02 0a c0 e3     bic        r0,r0,#0x2000
        00100328 10 0f 01 ee     mcr        p15,0x0,r0,cr1,cr0,0x0
        0010032c 50 00 9f e5     ldr        r0=&gt;LAB_00100000,[PTR_LAB_00100384]              = 00100000
        00100330 10 0f 0c ee     mcr        p15,0x0,r0,cr12,cr0,0x0
        00100334 56 00 00 eb     bl         FUN_00100494                                     undefined FUN_00100494()
        00100338 15 0f 07 ee     mcr        p15,0x0,r0,cr7,cr5,0x0
        0010033c 9a 0f 07 ee     mcr        p15,0x0,r0,cr7,cr10,0x4
        00100340 95 0f 07 ee     mcr        p15,0x0,r0,cr7,cr5,0x4
        00100344 1e ff 2f e1     bx         lr

</div></code></pre>
<p>If you look at both of these functions, they only have minor differences in the labels referenced at <code>0x4a000314</code> / <code>0010032c</code>.  This doesn't reveal much about the function of the bootloader, but it confirms for me that the version I compiled closely matches the version I pulled off the Netgear router.  It anecdotally suggests that the Netgear image is not heavily modified, but a full bindiff would be necessary to definitively draw that conclusion.</p>
<h2 id="bootloader-upgrade">Bootloader Upgrade</h2>
<p>One of the things I honed in on in the first part of this blog post is the string <code>NTGR</code>. The function that string is found in looks like this in the Ghidra decompiler:</p>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">maybe_remote_bootloader_upgrade</span><span class="hljs-params">(ushort *param_1)</span>

</span>{
  <span class="hljs-keyword">int</span> iVar1;
  ushort uVar2;
  code **ppcVar3;
  <span class="hljs-keyword">int</span> *piVar4;
  <span class="hljs-keyword">int</span> *piVar5;
  <span class="hljs-keyword">int</span> *piVar6;
  undefined4 *puVar7;
  undefined4 uVar8;
  undefined4 *puVar9;
  undefined *puVar10;
  <span class="hljs-keyword">int</span> iVar11;
  undefined *puVar12;
  code *pcVar13;
  uint uVar14;
  uint uVar15;
  ushort *puVar16;
  uint uVar17;
  <span class="hljs-keyword">int</span> in_stack_00000000;
  ushort local_6c;
  undefined local_6a;
  undefined local_69;
  ushort local_68;
  undefined2 local_66;
  undefined2 local_64;
  undefined auStack98 [<span class="hljs-number">74</span>];
  
  ppcVar3 = DAT_00136084;
  uVar17 = (uint)*(<span class="hljs-keyword">byte</span> *)(param_1 + <span class="hljs-number">1</span>);
  <span class="hljs-keyword">if</span> (in_stack_00000000 != <span class="hljs-number">0x912</span>) {
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">if</span> (((*DAT_00136084 != (code *)<span class="hljs-number">0x0</span>) &amp;&amp;
      (iVar11 = FUN_0010040e(<span class="hljs-number">0</span>), *DAT_0013608c &lt; (uint)(iVar11 - *DAT_00136088))) &amp;&amp;
     (*DAT_00136090 != uVar17)) {
    pcVar13 = *ppcVar3;
    *ppcVar3 = (code *)<span class="hljs-number">0x0</span>;
    (*pcVar13)();
  }
  uVar15 = (uint)*param_1;
  <span class="hljs-keyword">if</span> (uVar15 != <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span>;
  }
  puVar16 = param_1 + <span class="hljs-number">3</span>;
  FUN_001317d0(&amp;local_6c,<span class="hljs-number">0</span>,<span class="hljs-number">0x52</span>);
  local_6c = *param_1;
  local_68 = param_1[<span class="hljs-number">2</span>];
  local_6a = *(undefined *)(param_1 + <span class="hljs-number">1</span>);
  local_69 = *(undefined *)((<span class="hljs-keyword">int</span>)param_1 + <span class="hljs-number">3</span>);
  iVar11 = ((local_68 &amp; <span class="hljs-number">0xff</span>) &lt;&lt; <span class="hljs-number">8</span> | (uint)(local_68 &gt;&gt; <span class="hljs-number">8</span>)) - <span class="hljs-number">6</span>;
  <span class="hljs-keyword">while</span> (<span class="hljs-number">0</span> &lt; iVar11) {
    iVar1 = uVar15 * <span class="hljs-number">0xc</span>;
    uVar15 = uVar15 + <span class="hljs-number">1</span>;
    FUN_00131812(auStack98 + iVar1,puVar16,(puVar16[<span class="hljs-number">1</span>] &amp; <span class="hljs-number">0xff</span>) &lt;&lt; <span class="hljs-number">8</span> | (uint)(puVar16[<span class="hljs-number">1</span>] &gt;&gt; <span class="hljs-number">8</span>));
    uVar14 = (puVar16[<span class="hljs-number">1</span>] &amp; <span class="hljs-number">0xff</span>) &lt;&lt; <span class="hljs-number">8</span> | (uint)(puVar16[<span class="hljs-number">1</span>] &gt;&gt; <span class="hljs-number">8</span>);
    iVar11 = iVar11 - uVar14;
    puVar16 = (ushort *)((<span class="hljs-keyword">int</span>)puVar16 + uVar14);
  }
  local_66 = (undefined2)uVar15;
  local_64 = (undefined2)(uVar15 &gt;&gt; <span class="hljs-number">0x10</span>);
  <span class="hljs-keyword">if</span> (iVar11 != <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span>;
  }
  *DAT_00136094 = uVar17;
  <span class="hljs-keyword">if</span> (uVar17 == *DAT_00136098) {
    <span class="hljs-keyword">return</span>;
  }
  *DAT_00136098 = uVar17;
  puVar12 = PTR_s__NMRP_CLOSED_001360f8;
  piVar5 = DAT_001360f0;
  piVar4 = DAT_0013609c;
  <span class="hljs-keyword">switch</span>(uVar17) {
  <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
    <span class="hljs-keyword">if</span> (*DAT_0013609c != <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span>;
    }
    iVar11 = FUN_00135a38(&amp;local_6c,<span class="hljs-number">1</span>);
    <span class="hljs-keyword">if</span> (iVar11 == <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span>;
    }
    iVar11 = FUN_0013188e(iVar11 + <span class="hljs-number">4</span>,PTR_s_NTGR_001360a0,
                          ((*(ushort *)(iVar11 + <span class="hljs-number">2</span>) &amp; <span class="hljs-number">0xff</span>) &lt;&lt; <span class="hljs-number">8</span> | (uint)*(<span class="hljs-keyword">byte</span> *)(iVar11 + <span class="hljs-number">3</span>)) - <span class="hljs-number">4</span>)
    ;
    <span class="hljs-keyword">if</span> (iVar11 != <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span>;
    }
    *piVar4 = <span class="hljs-number">1</span>;
    FUN_0010291c();
    puVar12 = PTR_s__NMRP_CONFIGING_001360a4;
    <span class="hljs-keyword">break</span>;
  <span class="hljs-keyword">default</span>:
    <span class="hljs-keyword">goto</span> switchD_00135eec_caseD_2;
  <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
    <span class="hljs-keyword">if</span> (*DAT_0013609c != <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">return</span>;
    }
    iVar11 = FUN_00135a38(&amp;local_6c,<span class="hljs-number">2</span>);
    <span class="hljs-keyword">if</span> (iVar11 == <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span>;
    }
    FUN_00131812(PTR_DAT_001360a8,iVar11 + <span class="hljs-number">4</span>,<span class="hljs-number">4</span>);
    FUN_00131812(DAT_001360ac,iVar11 + <span class="hljs-number">8</span>,<span class="hljs-number">4</span>);
    iVar11 = FUN_00135a38(&amp;local_6c,<span class="hljs-number">4</span>);
    <span class="hljs-keyword">if</span> (iVar11 != <span class="hljs-number">0</span>) {
      maybe_error_out(PTR_s_Get_DEV-REGION_option,_value:<span class="hljs-number">0</span>x%_001360b0,*(undefined2 *)(iVar11 + <span class="hljs-number">4</span>));
      puVar12 = PTR_s_Write_Region_Number_0x%<span class="hljs-number">04</span>x_to_bo_001360b8;
      puVar16 = DAT_001360b4;
      uVar2 = (ushort)((*(ushort *)(iVar11 + <span class="hljs-number">4</span>) &amp; <span class="hljs-number">0xff</span>) &lt;&lt; <span class="hljs-number">8</span>) | *(ushort *)(iVar11 + <span class="hljs-number">4</span>) &gt;&gt; <span class="hljs-number">8</span>;
      *DAT_001360b4 = uVar2;
      maybe_error_out(puVar12,uVar2);
      FUN_00119c1c(*puVar16);
    }
    piVar5 = DAT_001360bc;
    iVar11 = FUN_00135a38(&amp;local_6c,<span class="hljs-number">0x101</span>);
    <span class="hljs-keyword">if</span> (iVar11 == <span class="hljs-number">0</span>) {
      maybe_error_out(PTR_s__No_FW-UP_option_001360c4);
      *piVar5 = <span class="hljs-number">0</span>;
    }
    <span class="hljs-keyword">else</span> {
      maybe_error_out(PTR_s__Recv_FW-UP_option_001360c0);
      *piVar5 = <span class="hljs-number">1</span>;
    }
    piVar6 = DAT_001360c8;
    iVar11 = FUN_00135a38(&amp;local_6c,<span class="hljs-number">0x102</span>);
    <span class="hljs-keyword">if</span> (iVar11 == <span class="hljs-number">0</span>) {
      maybe_error_out(PTR_s__No_ST-UP_option_001360e4);
      *piVar6 = <span class="hljs-number">0</span>;
    }
    <span class="hljs-keyword">else</span> {
      maybe_error_out(PTR_s__Recv_ST-UP_option_001360cc);
      uVar8 = DAT_001360d4;
      puVar7 = DAT_001360d0;
      *piVar6 = <span class="hljs-number">1</span>;
      puVar9 = DAT_001360d8;
      *puVar7 = <span class="hljs-number">0</span>;
      *puVar9 = <span class="hljs-number">0</span>;
      FUN_001317d0(uVar8,<span class="hljs-number">0</span>,<span class="hljs-number">0x80</span>);
      uVar17 = *(uint *)(iVar11 + <span class="hljs-number">4</span>);
      *DAT_001360dc =
           uVar17 &lt;&lt; <span class="hljs-number">0x18</span> | (uVar17 &gt;&gt; <span class="hljs-number">8</span> &amp; <span class="hljs-number">0xff</span>) &lt;&lt; <span class="hljs-number">0x10</span> | (uVar17 &gt;&gt; <span class="hljs-number">0x10</span> &amp; <span class="hljs-number">0xff</span>) &lt;&lt; <span class="hljs-number">8</span> |
           uVar17 &gt;&gt; <span class="hljs-number">0x18</span>;
      FUN_00135dec();
      maybe_error_out(PTR_s__Total_%d_String_Table_need_upda_001360e0,*puVar7);
    }
    puVar12 = PTR_s__NMRP_WAITING_FOR_UPLOAD_FIRMWAR_001360ec;
    puVar10 = PTR_s__No_firmware_update,_nor_string_t_001360e8;
    <span class="hljs-keyword">if</span> ((*piVar5 == <span class="hljs-number">0</span>) &amp;&amp; (*piVar6 == <span class="hljs-number">0</span>)) {
      *piVar4 = <span class="hljs-number">5</span>;
      puVar12 = puVar10;
    }
    <span class="hljs-keyword">else</span> {
      *piVar4 = <span class="hljs-number">2</span>;
    }
    <span class="hljs-keyword">break</span>;
  <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:
    <span class="hljs-keyword">if</span> (*DAT_0013609c != <span class="hljs-number">5</span>) {
      <span class="hljs-keyword">return</span>;
    }
    *DAT_0013609c = <span class="hljs-number">6</span>;
    <span class="hljs-keyword">break</span>;
  <span class="hljs-keyword">case</span> <span class="hljs-number">7</span>:
    <span class="hljs-keyword">if</span> ((*DAT_0013609c == <span class="hljs-number">7</span>) &amp;&amp; (*DAT_001360f0 == <span class="hljs-number">1</span>)) {
      *DAT_001360f4 = *DAT_001360f4 + <span class="hljs-number">0xf</span>;
      *piVar5 = <span class="hljs-number">0</span>;
    }
    <span class="hljs-keyword">goto</span> switchD_00135eec_caseD_2;
  }
  maybe_error_out(puVar12);
  maybe_tftp_os_firmware_recovery();
switchD_00135eec_caseD_2:
  <span class="hljs-keyword">return</span>;
}

</div></code></pre>
<p>Based on this function it looks like it has something to do with updating the firmware (bootloader firmware as opposed to OS firmware).  This string is interesting because it signifies custom functionality that the manufacturer may have coded into the bootloader.  Of course, this string is not going to exist in the BananaPi version.  However, some of the other strings in the function might be in the BananaPi version I compiled, so I checked a few.  The substring <code>NMRP</code> is used several times in the function, but it likewise does not appear anywhere in the BananaPi version.  None of the other strings and substrings I checked corresponded to anything in the BananaPi image.  My next step was to look in the Netgear image at locations where this function at <code>0x00135e20</code> (<code>maybe_remote_bootloader_upgrade</code>) is called and see if those functions have strings that I can find in the BananaPi version. I could not find any common strings in the parent functions either.  This suggests to me that the function containing the <code>NTGR</code> string and its parent functions are custom modifications made by the manufacturer to the bootloader.</p>
<p>This function looks to me like a way to update the bootloader firmware remotely. I'm not sure of the specifics, but it seems like the <code>NTGR</code> string may be a magic string that is either sent over the network or embedded in the update image blob.</p>
<p>I think the only time this capability would be possible is if the primary Linux OS did not boot properly.  At that point the bootloader starts a TFTP server on the router and you can reflash the OS firmware by sending a firmware image over the ethernet ports to the router IP.  This is a known, useful function of U-Boot. Upgrading the bootloader in this fashion is probably a relic left over from the development process, where it might be necessary to remotely flash new images directly to a real board in order to test out changes.</p>
<h2 id="u-boot-shell">U-Boot Shell</h2>
<p>One of the other things I identified in the Netgear image is the function responsible for the U-Boot shell.  I found this function by looking for a prompt string.  U-Boot has the ability to customize the shell prompt: the default value is <code>uboot&gt;</code> or <code>u-boot&gt;</code>, but can be changed by the OEM.  In this case I searched for strings in Ghidra that included the <code>&gt;</code> character, and I found <code>ALPINE_DB&gt;</code> which looks like the shell prompt to me.  The function it is contained in looks like this:</p>
<pre class="hljs"><code><div><span class="hljs-function">undefined4 <span class="hljs-title">maybe_shell_prompt</span><span class="hljs-params">(undefined4 param_1,<span class="hljs-keyword">int</span> param_2,<span class="hljs-keyword">char</span> **param_3,<span class="hljs-keyword">char</span> **param_4)</span>

</span>{
  <span class="hljs-keyword">char</span> cVar1;
  uint uVar2;
  <span class="hljs-keyword">int</span> iVar3;
  <span class="hljs-keyword">int</span> iVar4;
  <span class="hljs-keyword">char</span> *pcVar5;
  <span class="hljs-keyword">int</span> iVar6;
  <span class="hljs-keyword">char</span> *pcVar7;
  <span class="hljs-keyword">char</span> *pcVar8;
  <span class="hljs-keyword">char</span> *pcVar9;
  <span class="hljs-keyword">char</span> *pcVar10;
  <span class="hljs-keyword">char</span> *pcVar11;
  <span class="hljs-keyword">char</span> **ppcVar12;
  <span class="hljs-keyword">char</span> *pcVar13;
  <span class="hljs-keyword">int</span> iVar14;
  <span class="hljs-keyword">char</span> *pcVar15;
  <span class="hljs-keyword">int</span> *piVar16;
  <span class="hljs-keyword">char</span> *pcVar17;
  <span class="hljs-keyword">char</span> *pcVar18;
  undefined *puVar19;
  <span class="hljs-keyword">char</span> *apcStack184 [<span class="hljs-number">17</span>];
  <span class="hljs-keyword">int</span> iStack116;
  <span class="hljs-keyword">char</span> *local_70 [<span class="hljs-number">18</span>];
  undefined *local_28;
  
  pcVar10 = *param_3;
  pcVar11 = *param_4;
  uVar2 = maybe_prompt_output(param_1,PTR_s_ALPINE_DB&gt;_00121ab4);
  <span class="hljs-keyword">if</span> (uVar2 != <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
  }
  iVar3 = FUN_001316e0(param_2);
  <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> &lt; iVar3) {
    uVar2 = (uint)*(<span class="hljs-keyword">byte</span> *)(param_2 + iVar3 + <span class="hljs-number">-1</span>);
  }
  FUN_00131618(DAT_00121ab8,param_2);
  pcVar13 = DAT_00121ab8;
  pcVar9 = (<span class="hljs-keyword">char</span> *)<span class="hljs-number">0x0</span>;
  <span class="hljs-keyword">while</span>( <span class="hljs-literal">true</span> ) {
    <span class="hljs-keyword">do</span> {
      <span class="hljs-keyword">do</span> {
        pcVar18 = pcVar13;
        cVar1 = *pcVar18;
        pcVar13 = pcVar18 + <span class="hljs-number">1</span>;
      } <span class="hljs-keyword">while</span> (cVar1 == <span class="hljs-string">' '</span>);
    } <span class="hljs-keyword">while</span> (cVar1 == <span class="hljs-string">'\t'</span>);
    pcVar15 = pcVar9;
    <span class="hljs-keyword">if</span> (cVar1 == <span class="hljs-string">'\0'</span>) <span class="hljs-keyword">break</span>;
    pcVar15 = pcVar9 + <span class="hljs-number">1</span>;
    apcStack184[(<span class="hljs-keyword">int</span>)(pcVar9 + <span class="hljs-number">1</span>)] = pcVar18;
    <span class="hljs-keyword">do</span> {
      pcVar13 = pcVar18;
      cVar1 = *pcVar13;
      <span class="hljs-keyword">if</span> (cVar1 == <span class="hljs-string">'\0'</span>) <span class="hljs-keyword">goto</span> LAB_0012185a;
    } <span class="hljs-keyword">while</span> ((cVar1 != <span class="hljs-string">' '</span>) &amp;&amp; (pcVar18 = pcVar13 + <span class="hljs-number">1</span>, cVar1 != <span class="hljs-string">'\t'</span>));
    *pcVar13 = <span class="hljs-string">'\0'</span>;
    pcVar13 = pcVar13 + <span class="hljs-number">1</span>;
    pcVar9 = pcVar15;
    <span class="hljs-keyword">if</span> (pcVar15 == &amp;DataAbort) <span class="hljs-keyword">break</span>;
  }
LAB_0012185a:
  local_70[<span class="hljs-number">0</span>] = (<span class="hljs-keyword">char</span> *)<span class="hljs-number">0x0</span>;
  apcStack184[(<span class="hljs-keyword">int</span>)(pcVar15 + <span class="hljs-number">1</span>)] = (<span class="hljs-keyword">char</span> *)<span class="hljs-number">0x0</span>;
  pcVar13 = pcVar15;
  ppcVar12 = (<span class="hljs-keyword">char</span> **)PTR_PTR_s_base_00121abc;
  <span class="hljs-keyword">if</span> (pcVar15 == (<span class="hljs-keyword">char</span> *)<span class="hljs-number">0x0</span>) {
    <span class="hljs-keyword">while</span> ((<span class="hljs-keyword">char</span> **)PTR_PTR_s_baudrate_00121ac0 != ppcVar12) {
      <span class="hljs-keyword">if</span> (pcVar13 == (<span class="hljs-keyword">char</span> *)<span class="hljs-number">0x12</span>) {
        local_28 = PTR_s_..._00121ac4;
        pcVar13 = (<span class="hljs-keyword">char</span> *)<span class="hljs-number">0x13</span>;
        <span class="hljs-keyword">break</span>;
      }
      local_70[(<span class="hljs-keyword">int</span>)pcVar13] = *ppcVar12;
      pcVar13 = pcVar13 + <span class="hljs-number">1</span>;
      ppcVar12 = ppcVar12 + <span class="hljs-number">7</span>;
    }
LAB_0012193e:
    local_70[(<span class="hljs-keyword">int</span>)pcVar13] = (<span class="hljs-keyword">char</span> *)<span class="hljs-number">0x0</span>;
    <span class="hljs-keyword">if</span> (pcVar13 == (<span class="hljs-keyword">char</span> *)<span class="hljs-number">0x0</span>) <span class="hljs-keyword">goto</span> LAB_00121954;
  }
  <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span> (((pcVar15 == (<span class="hljs-keyword">char</span> *)<span class="hljs-number">0x1</span>) &amp;&amp; ((uVar2 &amp; <span class="hljs-number">0xdf</span>) != <span class="hljs-number">0</span>)) &amp;&amp; (uVar2 != <span class="hljs-number">9</span>)) {
      iVar4 = maybe_execute_shell_command(apcStack184[<span class="hljs-number">1</span>],<span class="hljs-number">0x2e</span>);
      <span class="hljs-keyword">if</span> (iVar4 == <span class="hljs-number">0</span>) {
        iVar4 = FUN_001316e0(apcStack184[<span class="hljs-number">1</span>]);
      }
      <span class="hljs-keyword">else</span> {
        iVar4 = iVar4 - (<span class="hljs-keyword">int</span>)apcStack184[<span class="hljs-number">1</span>];
      }
      pcVar13 = (<span class="hljs-keyword">char</span> *)<span class="hljs-number">0x0</span>;
      puVar19 = PTR_PTR_s_bdinfo_00121ad4;
      <span class="hljs-keyword">while</span> (PTR_PTR_s_baudrate_00121ac0 != puVar19 + <span class="hljs-number">-0x1c</span>) {
        iVar14 = FUN_001316e0(*(undefined4 *)(puVar19 + <span class="hljs-number">-0x1c</span>));
        pcVar9 = pcVar13;
        <span class="hljs-keyword">if</span> ((iVar4 &lt;= iVar14) &amp;&amp;
           (iVar14 = FUN_0013188e(apcStack184[<span class="hljs-number">1</span>],*(undefined4 *)(puVar19 + <span class="hljs-number">-0x1c</span>),iVar4),
           iVar14 == <span class="hljs-number">0</span>)) {
          pcVar9 = pcVar13 + <span class="hljs-number">1</span>;
          <span class="hljs-keyword">if</span> (<span class="hljs-number">0x11</span> &lt; (<span class="hljs-keyword">int</span>)pcVar13) {
            local_70[(<span class="hljs-keyword">int</span>)pcVar13] = PTR_s_..._00121ac4;
            pcVar13 = pcVar9;
            <span class="hljs-keyword">break</span>;
          }
          local_70[(<span class="hljs-keyword">int</span>)pcVar13] = *(<span class="hljs-keyword">char</span> **)(puVar19 + <span class="hljs-number">-0x1c</span>);
        }
        puVar19 = puVar19 + <span class="hljs-number">0x1c</span>;
        pcVar13 = pcVar9;
      }
      <span class="hljs-keyword">goto</span> LAB_0012193e;
    }
    iVar4 = FUN_00121640(apcStack184[<span class="hljs-number">1</span>]);
    <span class="hljs-keyword">if</span> ((iVar4 == <span class="hljs-number">0</span>) || (*(code **)(iVar4 + <span class="hljs-number">0x18</span>) == (code *)<span class="hljs-number">0x0</span>)) {
      local_70[<span class="hljs-number">0</span>] = (<span class="hljs-keyword">char</span> *)<span class="hljs-number">0x0</span>;
LAB_0012194e:
      <span class="hljs-keyword">if</span> (pcVar15 != (<span class="hljs-keyword">char</span> *)<span class="hljs-number">0x1</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
      }
      <span class="hljs-keyword">goto</span> LAB_00121954;
    }
    pcVar13 = (<span class="hljs-keyword">char</span> *)(**(code **)(iVar4 + <span class="hljs-number">0x18</span>))(pcVar15,apcStack184 + <span class="hljs-number">1</span>,uVar2,<span class="hljs-number">0x14</span>,local_70);
    <span class="hljs-keyword">if</span> (pcVar13 == (<span class="hljs-keyword">char</span> *)<span class="hljs-number">0x0</span>) <span class="hljs-keyword">goto</span> LAB_0012194e;
  }
  pcVar18 = local_70[<span class="hljs-number">0</span>];
  pcVar9 = PTR_s__00121acc;
  <span class="hljs-keyword">if</span> (pcVar13 == (<span class="hljs-keyword">char</span> *)<span class="hljs-number">0x1</span>) {
    iVar4 = FUN_001316e0(apcStack184[(<span class="hljs-keyword">int</span>)pcVar15]);
    pcVar18 = local_70[<span class="hljs-number">0</span>] + iVar4;
    pcVar5 = (<span class="hljs-keyword">char</span> *)FUN_001316e0(pcVar18);
  }
  <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span> (((<span class="hljs-keyword">int</span>)pcVar13 &lt; <span class="hljs-number">2</span>) || (local_70[<span class="hljs-number">0</span>] == (<span class="hljs-keyword">char</span> *)<span class="hljs-number">0x0</span>)) <span class="hljs-keyword">goto</span> LAB_00121a4e;
    pcVar5 = (<span class="hljs-keyword">char</span> *)FUN_001316e0(local_70[<span class="hljs-number">0</span>]);
    ppcVar12 = local_70;
    <span class="hljs-keyword">while</span>( <span class="hljs-literal">true</span> ) {
      ppcVar12 = ppcVar12 + <span class="hljs-number">1</span>;
      pcVar13 = *ppcVar12;
      <span class="hljs-keyword">if</span> (pcVar13 == (<span class="hljs-keyword">char</span> *)<span class="hljs-number">0x0</span>) <span class="hljs-keyword">break</span>;
      pcVar13 = pcVar13 + <span class="hljs-number">-1</span>;
      pcVar9 = pcVar18;
      <span class="hljs-keyword">do</span> {
        pcVar17 = pcVar9;
        <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">int</span>)pcVar5 &lt;= (<span class="hljs-keyword">int</span>)(pcVar17 + -(<span class="hljs-keyword">int</span>)pcVar18)) <span class="hljs-keyword">break</span>;
        pcVar13 = pcVar13 + <span class="hljs-number">1</span>;
        pcVar9 = pcVar17 + <span class="hljs-number">1</span>;
      } <span class="hljs-keyword">while</span> (*pcVar13 == *pcVar17);
      pcVar5 = pcVar17 + -(<span class="hljs-keyword">int</span>)pcVar18;
    }
    <span class="hljs-keyword">if</span> (pcVar5 == (<span class="hljs-keyword">char</span> *)<span class="hljs-number">0x0</span>) <span class="hljs-keyword">goto</span> LAB_00121a4e;
    iVar4 = FUN_001316e0(apcStack184[(<span class="hljs-keyword">int</span>)pcVar15]);
    pcVar5 = pcVar5 + -iVar4;
    <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">int</span>)pcVar5 &lt; <span class="hljs-number">1</span>) <span class="hljs-keyword">goto</span> LAB_00121a4e;
    pcVar18 = local_70[<span class="hljs-number">0</span>] + iVar4;
    pcVar9 = pcVar13;
  }
  <span class="hljs-keyword">if</span> (pcVar18 != (<span class="hljs-keyword">char</span> *)<span class="hljs-number">0x0</span>) {
    pcVar15 = pcVar5 + (<span class="hljs-keyword">int</span>)pcVar13;
    <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">int</span>)(pcVar15 + (<span class="hljs-keyword">int</span>)pcVar10) &lt; <span class="hljs-number">0x7fe</span>) {
      pcVar7 = (<span class="hljs-keyword">char</span> *)(iVar3 + param_2);
      pcVar17 = pcVar7 + <span class="hljs-number">-1</span>;
      pcVar8 = pcVar18;
      <span class="hljs-keyword">while</span> ((<span class="hljs-keyword">int</span>)(pcVar8 + -(<span class="hljs-keyword">int</span>)pcVar18) &lt; (<span class="hljs-keyword">int</span>)pcVar5) {
        pcVar17 = pcVar17 + <span class="hljs-number">1</span>;
        *pcVar17 = *pcVar8;
        pcVar8 = pcVar8 + <span class="hljs-number">1</span>;
      }
      <span class="hljs-keyword">if</span> (<span class="hljs-number">-1</span> &lt; (<span class="hljs-keyword">int</span>)pcVar5) {
        pcVar7 = pcVar7 + (<span class="hljs-keyword">int</span>)pcVar5;
      }
      <span class="hljs-keyword">if</span> (pcVar9 != (<span class="hljs-keyword">char</span> *)<span class="hljs-number">0x0</span>) {
        iVar3 = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">while</span> (iVar3 &lt; (<span class="hljs-keyword">int</span>)pcVar13) {
          *pcVar7 = *pcVar9;
          iVar3 = <span class="hljs-number">1</span>;
          pcVar7 = pcVar7 + <span class="hljs-number">1</span>;
        }
      }
      *pcVar7 = <span class="hljs-string">'\0'</span>;
      FUN_0011f102(pcVar7 + -(<span class="hljs-keyword">int</span>)pcVar15);
      <span class="hljs-keyword">if</span> (pcVar9 == (<span class="hljs-keyword">char</span> *)<span class="hljs-number">0x0</span>) {
        FUN_0011f0e6(<span class="hljs-number">7</span>);
      }
      *param_3 = pcVar15 + (<span class="hljs-keyword">int</span>)pcVar10;
      *param_4 = pcVar15 + (<span class="hljs-keyword">int</span>)pcVar11;
      <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }
LAB_00121954:
    FUN_0011f0e6(<span class="hljs-number">7</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
  }
LAB_00121a4e:
  piVar16 = &amp;iStack116;
  iVar14 = <span class="hljs-number">0x4e</span>;
  iVar3 = FUN_001316e0(PTR_DAT_00121ac8);
  iVar4 = FUN_001316e0(PTR_s__00121acc);
  <span class="hljs-keyword">while</span> (piVar16 = piVar16 + <span class="hljs-number">1</span>, *piVar16 != <span class="hljs-number">0</span>) {
    iVar6 = FUN_001316e0();
    <span class="hljs-keyword">if</span> (iVar14 + iVar6 + iVar4 &lt; <span class="hljs-number">0x4e</span>) {
      FUN_0011f102(PTR_s__00121acc);
    }
    <span class="hljs-keyword">else</span> {
      iVar14 = iVar3 - iVar4;
      FUN_0011f102(PTR_DAT_00121ad0);
      FUN_0011f102(PTR_DAT_00121ac8);
    }
    iVar14 = iVar14 + iVar6 + iVar4;
    FUN_0011f102(*piVar16);
  }
  maybe_error_out(PTR_DAT_00121ad0);
  FUN_0011f102(param_1);
  FUN_0011f102(param_2);
  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
}

</div></code></pre>
<p>This function looks to me to output the string <code>ALPINE_DB&gt;</code> to the console and then accept commands to execute.  It also looks to me to have tab completion capabilities, as well as the ability to output a list of available commands up to a certain limited number, whereby it then outputs an elipsis (<code>...</code>).  By analyzing this function I located the beginning of the list of shell functions (begins at address <code>0x00160384</code>).</p>
<p>I found the <code>flash_contents_boot_mode_default_app_set</code> and <code>flash_contents_boot_mode_default_app_show</code> commands.  These seems to be commands which allow a shell user to change the bootloader which is loaded by the stage 1 or 2 bootloader (the u-boot image is the third stage bootloader which is referred to as stage 2.5).  If thats the case, I can't think of a better way to easily scaffold up an entirely attacker-controlled boot process - starting at the U-boot level. It also seems like a really easy way to brick a router permanently - past the point of repair via TFTP.  I'm not exactly sure what type of argument the set command expects, but I bet its something similar to the output of the show command.  It might be necessary to first flash the new bootloader to SPI, which I believe is done through the <code>flash_contents_obj_update</code> command.  <strong>Warning</strong> messing around with these commands will most likely brick your router.</p>
<p>My take aways from analyzing these two functions and then difference checking the BananaPi version versus the Netgear version is that there are definitely custom modifications to the netgear image that would not appear in a stock U-Boot image.  Furthermore, it seems as though the Netgear U-Boot instance can modify the stage 1 / 2 bootloaders from a U-Boot command shell.</p>
<p>My next steps (oh yes, this blog post will have a part 3 now) are to try to extend modifying the U-boot parameters to the host operating system in order to see if I can execute arbitrary U-Boot shell commands from the Linux OS.  If that is the case, I feel like it might be possible to develop a bootkit for this device without physical access. Of course to actually do so would require a lot of time and a stack of routers to burn through, but most importantly, it will require some dynamic analsys in the form of interacting with the U-Boot instance, even if it is only to read the console output.</p>

</body>
</html>
