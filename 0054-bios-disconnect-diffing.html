<!DOCTYPE html>
<html>
<head>
<title>0054-bios-disconnect-diffing.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="%22bios-disconnect%22-vulnerability-diffing">&quot;BIOS Disconnect&quot; Vulnerability Diffing</h1>
<p>Published: June 27, 2021</p>
<h2 id="background">Background</h2>
<p>Recently Eclypsium announced the &quot;BIOS Disconnect&quot; vulnerabilities.  These are four previously unknown vulnerabilities in the <code>BIOSConnect</code> capability embedded in the UEFI implementation of newer Dell hosts.  Read more about it here:</p>
<p><a href="https://eclypsium.com/2021/06/24/biosdisconnect/">https://eclypsium.com/2021/06/24/biosdisconnect/</a></p>
<p>and here:</p>
<p><a href="https://eclypsium.com/wp-content/uploads/2021/06/Eclypsium-Discovers-Multiple-Vulnerabilities-Affecting-129-Dell-Models-via-Dell-Remote-OS-Recovery-and-Firmware-Update-Capabilities.pdf">https://eclypsium.com/wp-content/uploads/2021/06/Eclypsium-Discovers-Multiple-Vulnerabilities-Affecting-129-Dell-Models-via-Dell-Remote-OS-Recovery-and-Firmware-Update-Capabilities.pdf</a></p>
<p><strong>Note that I was not involved in any way in the discovery of these vulnerabilities and full credit is due to the researchers at Eclypsium</strong></p>
<p>The biggest flaw, and the flaw that enabled the other three vulnerabilities to be exploited, was the lack of hostname validation when retrieiving firmware metadata from vendor-controlled servers. Any valid TLS cert, albeit with a different hostname, would be excepted in vulnerable versions of the firmware.</p>
<h2 id="intent">Intent</h2>
<p>The intent of this article is to examine the vendor provided fixes for the &quot;BIOS Disconnect&quot; vulnerabilities.  We will use a suite of tools to manipulate the firmware images, search them, and look at the differences.  This article only focuses on only one of the four discovered vulnerabilities.</p>
<p>On a Dell XPS 9500, the fixed firmware version was <code>1.8.1</code> and the last vulnerable version was <code>1.7.1</code>.</p>
<ul>
<li><code>1.8.1</code> - <a href="https://dl.dell.com/FOLDER07401752M/1/XPS_9500_1.8.1.exe">https://dl.dell.com/FOLDER07401752M/1/XPS_9500_1.8.1.exe</a></li>
<li><code>1.7.1</code> - <a href="https://dl.dell.com/FOLDER07196164M/1/XPS_9500_1.7.1.exe">https://dl.dell.com/FOLDER07196164M/1/XPS_9500_1.7.1.exe</a></li>
</ul>
<p>Note that these are windows-based executables for launching the UEFI updates downloaded directly from the vendor.  They contain the actual UEFI implementation binary images within themselves.  We will need to use a tool to extract the UEFI image from these <code>.exe</code> installer files.</p>
<h2 id="extraction">Extraction</h2>
<p>We will use this script to extract the firmware images from the installers:</p>
<p><a href="https://github.com/platomav/BIOSUtilities/raw/master/Dell%20PFS%20BIOS%20Extractor/Dell_PFS_Extract.py">https://github.com/platomav/BIOSUtilities/raw/master/Dell%20PFS%20BIOS%20Extractor/Dell_PFS_Extract.py</a></p>
<p>Grab that script and run it against each of the <code>.exe</code> files:</p>
<pre class="hljs"><code><div>$ python3 Dell_PFS_Extract.py XPS_9500_1.7.1.exe
$ python3 Dell_PFS_Extract.py XPS_9500_1.8.1.exe
</div></code></pre>
<p>This will create two directories with various firmware-related binary images in it:</p>
<pre class="hljs"><code><div>XPS_9500_1.8.1.exe_extracted 
XPS_9500_1.7.1.exe_extracted 
</div></code></pre>
<p>The contents of these directories will look like this:</p>
<pre class="hljs"><code><div>$ ls XPS_9500_1.8.1.exe_extracted/
'1 -- 1 System BIOS with BiosGuard v1.8.1.bin'   '1 -- 15 BiosConnect Core FV v1.19.5.bin'                                     '1 -- 5 Integrated Sensor Hub PDT Data v0.0.0.2.bin'
'1 -- 10 Embedded Controller v1.0.7.bin'         '1 -- 16 BiosConnect Wireless FV v1.19.5.bin'                                 '1 -- 6 Main System Cypress Port Controller 0 v1.12.64.50.bin'
'1 -- 11 Backup Embedded Controller v1.0.5.bin'  '1 -- 17 Model Information v1.0.0.0.txt'                                      '1 -- 7 Main System Cypress Port Controller 1 v1.10.64.30.bin'
'1 -- 12 Cypress MCU FW v71.61.11.1.bin'         '1 -- 2 Intel Management Engine Corporate Firmware Update v14.1.53.1649.bin'  '1 -- 8 Embedded Controller v1.0.7.bin'
'1 -- 13 PCR0 XML v0.0.0.1.xml'                  '1 -- 3 Intel Management Engine Consumer Firmware Update v14.1.53.1649.bin'   '1 -- 9 Backup Embedded Controller v1.0.5.bin'

</div></code></pre>
<p><code>'1 -- 1 System BIOS with BiosGuard v1.8.1.bin'</code> is the file I started with. I also tried <code>'1 -- 15 BiosConnect Core FV v1.19.5.bin'</code> and then <code>'1 -- 16 BiosConnect Wireless FV v1.19.5.bin'</code>.  The latter turned out to contain the code responsible for the vulnerability.</p>
<h1 id="searching">Searching</h1>
<p>Next we need to find the specific UEFI module that contains the code in question.  This is a difficult task because we don't know exactly what to look for.  Also, Ghidra does not have indexing capabilities for entire firmware images as far as I know.  The easiest way to search these binaries for strings is by using <a href="https://github.com/LongSoft/UEFITool">UEFITool</a>.</p>
<p>Open up UEFITool and load each firmware image into different UEFITool windows.  Then hit <code>CTRL+F</code> to search the UEFI image for strings. If there is a match, UEFITool will report the location of the string in terms of UEFI modules.  That way we can hone in on a few modules, searching by keywords, to begin our quest for finding the proper UEFI module that handles the functionality in question.</p>
<p>A few notes on searching: I usually try to search with Unicode enabled and disabled.  Sometimes strings in UEFI implementations are unicode; some times they are ASCII.  Searching for both will often yield results you wouldn't otherwise see. Also, I usually search with case sensitivity disabled, unless I really know what I am looking for.</p>
<p>The original PDF writeup mentions a few clues to help use narrow our search:</p>
<blockquote>
<p>The process of verifying the certificate for dell.com is done by first retrieving the DNS record from the hard-coded server 8.8.8.8 (Google) then establishing a connection to https://downloads.dell.com</p>
</blockquote>
<p>We want to search for <code>https://downloads.dell.com</code> using UEFI Tool in the <code>'1 -- 16 BiosConnect Wireless FV v1.19.5.bin'</code> file. I also searched for <code>8.8.8.8</code>.</p>
<p><img src="images/0054/uefitool-search-results.PNG" alt="UEFITool Search Results" title="UEFITool Search Results Screenshot"></p>
<p>The results for these searches, which were the same for both firmware images, are listed below:</p>
<pre class="hljs"><code><div>ASCII text &quot;downloads.dell.com&quot; in 350F9ED6-206C-4288-BDD1-8BAD8C053112/PE32 image section at header-offset 14154h
ASCII text &quot;8.8.8.8&quot; in B94FC17C-579C-4AB3-BA28-678D1813D1D6/PE32 image section at header-offset 16CB4h
ASCII text &quot;8.8.8.8&quot; in 350F9ED6-206C-4288-BDD1-8BAD8C053112/PE32 image section at header-offset 14314h
</div></code></pre>
<p>The strings <code>downloads.dell.com</code> and <code>8.8.8.8</code> appear in a DXE Driver named <code>DellServiceApp</code>. <code>8.8.8.8</code> also appears in another DXE Driver named <code>DellBiosConnectNetwork</code>. First lets look at <code>DellServiceApp</code>. I right click on the corresponding entry in the UEFITool mainview and select <code>Export Body</code> for each version. Next I load both PE32 files into Ghidra and perform the autoanalysis, including with <code>efiSeek</code> analysis enabled. By looking up the <code>downloads.dell.com</code> string address in Ghidra, I learn that the string exists in the function at address <code>0x80001318</code> (<code>1.7.1</code>) and <code>0x8000131c</code> (<code>1.8.1</code>).  This tells me I have the right DXE driver to reverse engineer.</p>
<h2 id="finding-the-fix">Finding the fix</h2>
<p>Using Ghidra, I looked through the strings in the <code>DellServiceApp</code> for version <code>1.8.1</code> and ended up seeing this:</p>
<p><code>&quot;Failed to verify URL.&quot;</code></p>
<p>This looks like a promising string to take a look at.  The whole function looks like this:</p>
<pre class="hljs"><code><div><span class="hljs-function">EFI_STATUS
<span class="hljs-title">verify_url</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *param_1,<span class="hljs-keyword">char</span> *param_2,ulonglong param_3,longlong *param_4,<span class="hljs-keyword">byte</span> **param_5,
          longlong *param_6)</span>

</span>{
  <span class="hljs-keyword">char</span> **ppcVar1;
  ulonglong *puVar2;
  ulonglong uVar3;
  <span class="hljs-keyword">byte</span> **ppbVar4;
  longlong *plVar5;
  <span class="hljs-keyword">int</span> iVar6;
  <span class="hljs-keyword">char</span> cVar7;
  EFI_STATUS EVar8;
  undefined8 uVar9;
  ulonglong uVar10;
  <span class="hljs-keyword">char</span> *pcVar11;
  <span class="hljs-keyword">char</span> *pcVar12;
  longlong lVar13;
  ulonglong uVar14;
  longlong *local_res20;
  undefined4 local_498;
  <span class="hljs-keyword">int</span> local_494 [<span class="hljs-number">3</span>];
  ulonglong local_488;
  ulonglong local_480;
  ulonglong local_478;
  INT64 *unknownProtocol_0ad355e121;
  INT64 *unknownProtocol_92fd000918;
  ulonglong local_458;
  ulonglong local_450;
  longlong local_448;
  undefined8 local_438;
  undefined8 local_338;
  <span class="hljs-keyword">char</span> local_13a [<span class="hljs-number">258</span>];
  
  local_338._0_1_ = <span class="hljs-number">0</span>;
  local_res20 = param_4;
  FUN_80016fd4((undefined *)((longlong)&amp;local_338 + <span class="hljs-number">1</span>),<span class="hljs-number">0</span>,<span class="hljs-number">0x2fc</span>);
  local_438._0_1_ = <span class="hljs-number">0</span>;
  FUN_80016fd4((undefined *)((longlong)&amp;local_438 + <span class="hljs-number">1</span>),<span class="hljs-number">0</span>,<span class="hljs-number">0xfe</span>);
  local_498 = <span class="hljs-number">0</span>;
  unknownProtocol_0ad355e121 = (INT64 *)<span class="hljs-number">0x0</span>;
  unknownProtocol_92fd000918 = (INT64 *)<span class="hljs-number">0x0</span>;
  local_494[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;
  FUN_80017070((undefined *)&amp;local_338,<span class="hljs-number">0x2fd</span>,<span class="hljs-number">0</span>);
  FUN_80017070((undefined *)&amp;local_438,<span class="hljs-number">0xff</span>,<span class="hljs-number">0</span>);
  EVar8 = (*gBS_223-&gt;LocateProtocol)
                    (&amp;unknownProtocol_0ad355e1,(<span class="hljs-keyword">void</span> *)<span class="hljs-number">0x0</span>,&amp;unknownProtocol_0ad355e121);
  <span class="hljs-keyword">if</span> ((longlong)EVar8 &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> EVar8;
  }
  <span class="hljs-keyword">if</span> (unknownProtocol_0ad355e121 == (INT64 *)<span class="hljs-number">0x0</span>) {
    <span class="hljs-keyword">return</span> EVar8;
  }
  EVar8 = FUN_8000943c((longlong)unknownProtocol_0ad355e121,param_2,(<span class="hljs-keyword">int</span>)param_3,local_494);
  iVar6 = local_494[<span class="hljs-number">0</span>];
  plVar5 = param_6;
  ppbVar4 = param_5;
  <span class="hljs-keyword">if</span> ((longlong)EVar8 &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">0x800000000000000e</span>;
  }
  cVar7 = <span class="hljs-string">'\x02'</span>;
LAB_8000aea8:
  <span class="hljs-keyword">do</span> {
    <span class="hljs-keyword">if</span> (cVar7 == <span class="hljs-string">'\x02'</span>) {
      EVar8 = (*gBS_223-&gt;LocateProtocol)
                        (&amp;unknownProtocol_92fd0009,(<span class="hljs-keyword">void</span> *)<span class="hljs-number">0x0</span>,&amp;unknownProtocol_92fd000918);
      <span class="hljs-keyword">if</span> ((longlong)EVar8 &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> EVar8;
      }
      <span class="hljs-keyword">if</span> (unknownProtocol_92fd000918 == (INT64 *)<span class="hljs-number">0x0</span>) {
        <span class="hljs-keyword">return</span> EVar8;
      }
      EVar8 = FUN_8000a0fc((longlong)unknownProtocol_0ad355e121,
                           (undefined **)unknownProtocol_92fd000918,param_2,param_3,ppbVar4);
      <span class="hljs-keyword">if</span> ((longlong)EVar8 &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">if</span> (iVar6 == <span class="hljs-number">2</span>) {
          (**(code **)(*plVar5 + <span class="hljs-number">0x40</span>))(<span class="hljs-number">4</span>,s_Failed_to_verify_URL._80019e78,&amp;local_498);
          <span class="hljs-keyword">if</span> (*param_4 != <span class="hljs-number">0</span>) {
            FUN_800086bc(&amp;local_res20,(longlong **)&amp;param_5);
            <span class="hljs-keyword">return</span> EVar8;
          }
          <span class="hljs-keyword">return</span> EVar8;
        }
      }
      <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (iVar6 == <span class="hljs-number">2</span>) {
          (**(code **)(*plVar5 + <span class="hljs-number">0x50</span>))();
        }
      }
      <span class="hljs-keyword">if</span> (iVar6 == <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span> EVar8;
      }
      <span class="hljs-keyword">if</span> (iVar6 == <span class="hljs-number">2</span>) {
        cVar7 = <span class="hljs-string">'\x03'</span>;
      }
    }
    <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (cVar7 == <span class="hljs-string">'\x03'</span>) {
        <span class="hljs-keyword">if</span> (ppbVar4[<span class="hljs-number">8</span>] != (<span class="hljs-keyword">byte</span> *)<span class="hljs-number">0x0</span>) {
          (**(code **)(*plVar5 + <span class="hljs-number">0x50</span>))(s_Checking_cloud_SOS_Schema_versio_8001ada0);
          puVar2 = (ulonglong *)ppbVar4[<span class="hljs-number">8</span>];
          local_488 = *puVar2;
          local_480 = puVar2[<span class="hljs-number">1</span>];
          local_478 = puVar2[<span class="hljs-number">2</span>];
          <span class="hljs-keyword">if</span> ((local_488 != <span class="hljs-number">0</span>) &amp;&amp; (((<span class="hljs-number">1</span> &lt; local_488 || (local_480 != <span class="hljs-number">0</span>)) || (local_478 != <span class="hljs-number">0</span>)))) {
            uVar10 = <span class="hljs-number">0</span>;
            uVar14 = uVar10;
            <span class="hljs-keyword">if</span> (puVar2[<span class="hljs-number">6</span>] != <span class="hljs-number">0</span>) <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">goto</span> LAB_8000b4c8;
          }
          (**(code **)(*plVar5 + <span class="hljs-number">0x50</span>))();
        }
        cVar7 = <span class="hljs-string">'\x04'</span>;
        <span class="hljs-keyword">goto</span> LAB_8000aea8;
      }
      <span class="hljs-keyword">if</span> (cVar7 == <span class="hljs-string">'\x04'</span>) {
        <span class="hljs-keyword">if</span> ((param_4[<span class="hljs-number">2</span>] != <span class="hljs-number">0</span>) &amp;&amp; (pcVar11 = (<span class="hljs-keyword">char</span> *)param_4[<span class="hljs-number">2</span>], pcVar11 != (<span class="hljs-keyword">char</span> *)<span class="hljs-number">0x0</span>)) {
          lVar13 = <span class="hljs-number">0</span>;
          cVar7 = *pcVar11;
          <span class="hljs-keyword">while</span> (pcVar12 = pcVar11, cVar7 != <span class="hljs-string">'\0'</span>) {
            lVar13 = lVar13 + <span class="hljs-number">1</span>;
            cVar7 = pcVar11[lVar13];
          }
          <span class="hljs-keyword">while</span> (((<span class="hljs-keyword">char</span> *)(lVar13 + <span class="hljs-number">1</span>) != (<span class="hljs-keyword">char</span> *)<span class="hljs-number">0x0</span> &amp;&amp;
                 (pcVar12 = FUN_80017050(pcVar12,(<span class="hljs-keyword">char</span> *)(lVar13 + <span class="hljs-number">1</span>),<span class="hljs-string">'/'</span>), pcVar12 != (<span class="hljs-keyword">char</span> *)<span class="hljs-number">0x0</span>))
                ) {
            pcVar11[(<span class="hljs-keyword">int</span>)pcVar12 - (<span class="hljs-keyword">int</span>)pcVar11] = <span class="hljs-string">'\\'</span>;
            pcVar12 = pcVar12 + <span class="hljs-number">1</span>;
            lVar13 = <span class="hljs-number">0</span>;
            cVar7 = *pcVar12;
            <span class="hljs-keyword">while</span> (cVar7 != <span class="hljs-string">'\0'</span>) {
              lVar13 = lVar13 + <span class="hljs-number">1</span>;
              cVar7 = pcVar12[lVar13];
            }
          }
        }
        cVar7 = <span class="hljs-string">'\x06'</span>;
        <span class="hljs-keyword">goto</span> LAB_8000aea8;
      }
      <span class="hljs-keyword">if</span> (cVar7 == <span class="hljs-string">'\x06'</span>) {
        ppcVar1 = (<span class="hljs-keyword">char</span> **)ppbVar4[<span class="hljs-number">7</span>];
        uVar9 = FUN_80010a2c(*ppcVar1);
        uVar14 = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">char</span>)uVar9 == <span class="hljs-string">'\0'</span>) {
          (**(code **)(*plVar5 + <span class="hljs-number">0x40</span>))(<span class="hljs-number">4</span>,s_Invalid_file_content_8001ae50,&amp;local_498);
          <span class="hljs-keyword">if</span> (*(<span class="hljs-keyword">void</span> **)ppbVar4[<span class="hljs-number">7</span>] != (<span class="hljs-keyword">void</span> *)<span class="hljs-number">0x0</span>) {
            (*gBS_223-&gt;FreePool)(*(<span class="hljs-keyword">void</span> **)ppbVar4[<span class="hljs-number">7</span>]);
          }
          <span class="hljs-keyword">if</span> (*(<span class="hljs-keyword">void</span> **)(ppbVar4[<span class="hljs-number">7</span>] + <span class="hljs-number">0x10</span>) != (<span class="hljs-keyword">void</span> *)<span class="hljs-number">0x0</span>) {
            (*gBS_223-&gt;FreePool)(*(<span class="hljs-keyword">void</span> **)(ppbVar4[<span class="hljs-number">7</span>] + <span class="hljs-number">0x10</span>));
          }
          <span class="hljs-keyword">if</span> (*(<span class="hljs-keyword">void</span> **)(ppbVar4[<span class="hljs-number">7</span>] + <span class="hljs-number">0x18</span>) != (<span class="hljs-keyword">void</span> *)<span class="hljs-number">0x0</span>) {
            (*gBS_223-&gt;FreePool)(*(<span class="hljs-keyword">void</span> **)(ppbVar4[<span class="hljs-number">7</span>] + <span class="hljs-number">0x18</span>));
          }
        }
        <span class="hljs-keyword">else</span> {
          FUN_800081e0(ppcVar1[<span class="hljs-number">2</span>]);
          pcVar11 = *(<span class="hljs-keyword">char</span> **)((longlong)ppbVar4[<span class="hljs-number">7</span>] + <span class="hljs-number">0x10</span>);
          uVar10 = uVar14;
          <span class="hljs-keyword">if</span> (pcVar11 != (<span class="hljs-keyword">char</span> *)<span class="hljs-number">0x0</span>) {
            <span class="hljs-keyword">do</span> {
              <span class="hljs-keyword">if</span> (pcVar11[uVar10] == <span class="hljs-string">'\0'</span>) <span class="hljs-keyword">break</span>;
              uVar10 = uVar10 + <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">while</span> (uVar10 &lt; <span class="hljs-number">0x400</span>);
            <span class="hljs-keyword">if</span> (<span class="hljs-number">1</span> &lt; uVar10) {
              <span class="hljs-keyword">do</span> {
                <span class="hljs-keyword">if</span> (pcVar11[uVar14] == <span class="hljs-string">'\0'</span>) <span class="hljs-keyword">break</span>;
                uVar14 = uVar14 + <span class="hljs-number">1</span>;
              } <span class="hljs-keyword">while</span> (uVar14 &lt; <span class="hljs-number">0x400</span>);
              <span class="hljs-keyword">if</span> ((pcVar11[uVar14 - <span class="hljs-number">1</span>] != <span class="hljs-string">'/'</span>) &amp;&amp; (*pcVar11 != <span class="hljs-string">'.'</span>)) {
                <span class="hljs-keyword">if</span> (param_1 == (<span class="hljs-keyword">char</span> *)<span class="hljs-number">0x0</span>) {
                  EVar8 = <span class="hljs-number">0x8000000000000002</span>;
                }
                <span class="hljs-keyword">else</span> {
                  EVar8 = FUN_80008f98(param_1,*(<span class="hljs-keyword">char</span> **)ppbVar4[<span class="hljs-number">7</span>],&amp;local_438);
                }
                <span class="hljs-keyword">if</span> ((longlong)EVar8 &lt; <span class="hljs-number">0</span>) {
                  <span class="hljs-keyword">return</span> EVar8;
                }
                EVar8 = FUN_80010acc(&amp;local_438,&amp;local_338);
                <span class="hljs-keyword">if</span> ((longlong)EVar8 &lt; <span class="hljs-number">0</span>) {
                  <span class="hljs-keyword">return</span> EVar8;
                }
                pcVar12 = s_cacert.pem_8001ae68;
                pcVar11 = local_13a;
                cVar7 = local_13a[<span class="hljs-number">0</span>];
                <span class="hljs-keyword">while</span> ((cVar7 != <span class="hljs-string">'\0'</span> &amp;&amp; (cVar7 == *pcVar12))) {
                  pcVar11 = pcVar11 + <span class="hljs-number">1</span>;
                  pcVar12 = pcVar12 + <span class="hljs-number">1</span>;
                  cVar7 = *pcVar11;
                }
                <span class="hljs-keyword">if</span> (*pcVar11 == *pcVar12) {
                  (**(code **)(*plVar5 + <span class="hljs-number">0x50</span>))(s_Verifying_file_signature_8001ab08);
                  uVar14 = FUN_8001081c((longlong)unknownProtocol_92fd000918,
                                        *(<span class="hljs-keyword">char</span> **)(ppbVar4[<span class="hljs-number">7</span>] + <span class="hljs-number">0x10</span>),
                                        *(longlong *)(ppbVar4[<span class="hljs-number">7</span>] + <span class="hljs-number">0x18</span>));
                  <span class="hljs-keyword">if</span> ((longlong)uVar14 &lt; <span class="hljs-number">0</span>) {
                    (**(code **)(*plVar5 + <span class="hljs-number">0x40</span>))(<span class="hljs-number">4</span>,s_Failed_to_verify_file._8001ae78,&amp;local_498);
                    <span class="hljs-keyword">return</span> uVar14;
                  }
                  (**(code **)(*plVar5 + <span class="hljs-number">0x50</span>))(s_File_signature_verified_8001ab28);
                  DAT_8001d30b = <span class="hljs-number">1</span>;
                  EVar8 = FUN_80008238(plVar5[<span class="hljs-number">6</span>],*(<span class="hljs-keyword">char</span> **)(ppbVar4[<span class="hljs-number">7</span>] + <span class="hljs-number">0x10</span>),
                                       *(longlong *)(ppbVar4[<span class="hljs-number">7</span>] + <span class="hljs-number">0x18</span>));
                  <span class="hljs-keyword">if</span> ((longlong)EVar8 &lt; <span class="hljs-number">0</span>) {
                    (**(code **)(*plVar5 + <span class="hljs-number">0x40</span>))(<span class="hljs-number">4</span>,s_Failed_to_verify_file._8001ae78,&amp;local_498);
                    <span class="hljs-keyword">return</span> EVar8;
                  }
                }
                FUN_80017070((undefined *)&amp;local_438,<span class="hljs-number">0xff</span>,<span class="hljs-number">0</span>);
                FUN_80017070((undefined *)&amp;local_338,<span class="hljs-number">0x2fd</span>,<span class="hljs-number">0</span>);
                cVar7 = <span class="hljs-string">'\a'</span>;
                <span class="hljs-keyword">goto</span> LAB_8000aea8;
              }
            }
          }
          (**(code **)(*plVar5 + <span class="hljs-number">0x40</span>))(<span class="hljs-number">4</span>,s_Invalid_file_content_8001ae50,&amp;local_498);
          <span class="hljs-keyword">if</span> (*(<span class="hljs-keyword">void</span> **)ppbVar4[<span class="hljs-number">7</span>] != (<span class="hljs-keyword">void</span> *)<span class="hljs-number">0x0</span>) {
            (*gBS_223-&gt;FreePool)(*(<span class="hljs-keyword">void</span> **)ppbVar4[<span class="hljs-number">7</span>]);
          }
          <span class="hljs-keyword">if</span> (*(<span class="hljs-keyword">void</span> **)(ppbVar4[<span class="hljs-number">7</span>] + <span class="hljs-number">0x10</span>) != (<span class="hljs-keyword">void</span> *)<span class="hljs-number">0x0</span>) {
            (*gBS_223-&gt;FreePool)(*(<span class="hljs-keyword">void</span> **)(ppbVar4[<span class="hljs-number">7</span>] + <span class="hljs-number">0x10</span>));
          }
          <span class="hljs-keyword">if</span> (*(<span class="hljs-keyword">void</span> **)(ppbVar4[<span class="hljs-number">7</span>] + <span class="hljs-number">0x18</span>) != (<span class="hljs-keyword">void</span> *)<span class="hljs-number">0x0</span>) {
            (*gBS_223-&gt;FreePool)(*(<span class="hljs-keyword">void</span> **)(ppbVar4[<span class="hljs-number">7</span>] + <span class="hljs-number">0x18</span>));
          }
        }
        ppbVar4[<span class="hljs-number">7</span>] = (<span class="hljs-keyword">byte</span> *)<span class="hljs-number">0x0</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-number">0x8000000000000002</span>;
      }
      <span class="hljs-keyword">if</span> (cVar7 == <span class="hljs-string">'\a'</span>) {
        uVar14 = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (param_4[<span class="hljs-number">3</span>] == <span class="hljs-number">0</span>) {
          <span class="hljs-keyword">return</span> EVar8;
        }
        lVar13 = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">goto</span> LAB_8000aedf;
      }
    }
    <span class="hljs-keyword">if</span> (cVar7 == <span class="hljs-string">'\t'</span>) {
      <span class="hljs-keyword">return</span> EVar8;
    }
  } <span class="hljs-keyword">while</span>( <span class="hljs-literal">true</span> );
LAB_8000b440:
  uVar3 = puVar2[<span class="hljs-number">7</span>];
  local_458 = *(ulonglong *)(uVar3 + uVar10);
  local_450 = *(ulonglong *)(uVar3 + <span class="hljs-number">8</span> + uVar10);
  local_448 = *(longlong *)(uVar3 + <span class="hljs-number">0x10</span> + uVar10);
  <span class="hljs-keyword">if</span> (((local_458 != <span class="hljs-number">0</span>) &amp;&amp; (local_458 &lt; <span class="hljs-number">2</span>)) &amp;&amp; ((local_450 == <span class="hljs-number">0</span> &amp;&amp; (local_448 == <span class="hljs-number">0</span>)))) {
    (**(code **)(*plVar5 + <span class="hljs-number">0x50</span>))(s_Downloading_compatible_cloud_SOS_8001ae00);
    lVar13 = uVar14 * <span class="hljs-number">0x118</span> + <span class="hljs-number">0x18</span> + *(longlong *)(ppbVar4[<span class="hljs-number">8</span>] + <span class="hljs-number">0x38</span>);
LAB_8000b511:
    uVar14 = maybe_download(plVar5,lVar13);
    <span class="hljs-keyword">return</span> uVar14;
  }
  local_488 = *(ulonglong *)(uVar3 + uVar10);
  local_478 = *(ulonglong *)(uVar3 + <span class="hljs-number">0x10</span> + uVar10);
  local_480 = local_450;
  <span class="hljs-keyword">if</span> (((local_488 &gt; DAT_8001d378 || DAT_8001d378 == local_488) &amp;&amp; (local_488 &lt;= DAT_8001d378)) &amp;&amp;
     ((local_450 &gt; DAT_8001d380 || DAT_8001d380 == local_450 &amp;&amp;
      (((local_450 &lt;= DAT_8001d380 &amp;&amp; (local_478 &gt; DAT_8001d388 || DAT_8001d388 == local_478)) &amp;&amp;
       (local_478 &lt;= DAT_8001d388)))))) {
    (**(code **)(*plVar5 + <span class="hljs-number">0x50</span>))(s_Downloading_compatible_cloud_SOS_8001ae00);
    lVar13 = uVar14 * <span class="hljs-number">0x118</span> + <span class="hljs-number">0x18</span> + *(longlong *)(ppbVar4[<span class="hljs-number">8</span>] + <span class="hljs-number">0x38</span>);
    <span class="hljs-keyword">goto</span> LAB_8000b511;
  }
  uVar14 = uVar14 + <span class="hljs-number">1</span>;
  uVar10 = uVar10 + <span class="hljs-number">0x118</span>;
  <span class="hljs-keyword">if</span> (puVar2[<span class="hljs-number">6</span>] &lt;= uVar14) {
LAB_8000b4c8:
    (**(code **)(*plVar5 + <span class="hljs-number">0x40</span>))(<span class="hljs-number">4</span>,s_Compatible_cloud_SOS_not_found_8001ae30,&amp;local_498);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0x8000000000000002</span>;
  }
  <span class="hljs-keyword">goto</span> LAB_8000b440;
LAB_8000aedf:
  uVar9 = FUN_80010a2c(*(<span class="hljs-keyword">char</span> **)(lVar13 + *param_4));
  <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">char</span>)uVar9 == <span class="hljs-string">'\0'</span>) {
    (**(code **)(*plVar5 + <span class="hljs-number">0x40</span>))(<span class="hljs-number">4</span>,s_Invalid_file_content_8001ae50,&amp;local_498);
    FUN_800086bc(&amp;local_res20,(longlong **)&amp;param_5);
    EVar8 = <span class="hljs-number">0x8000000000000002</span>;
    param_4 = local_res20;
  }
  FUN_800081e0(*(<span class="hljs-keyword">char</span> **)(lVar13 + <span class="hljs-number">0x10</span> + *param_4));
  pcVar11 = *(<span class="hljs-keyword">char</span> **)(lVar13 + <span class="hljs-number">0x10</span> + *param_4);
  <span class="hljs-keyword">if</span> (pcVar11 == (<span class="hljs-keyword">char</span> *)<span class="hljs-number">0x0</span>) {
LAB_8000b2cb:
    (**(code **)(*plVar5 + <span class="hljs-number">0x40</span>))(<span class="hljs-number">4</span>,s_Invalid_file_content_8001ae50,&amp;local_498);
    FUN_800086bc(&amp;local_res20,(longlong **)&amp;param_5);
    EVar8 = <span class="hljs-number">0x8000000000000002</span>;
    param_4 = local_res20;
  }
  <span class="hljs-keyword">else</span> {
    uVar10 = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">do</span> {
      <span class="hljs-keyword">if</span> (pcVar11[uVar10] == <span class="hljs-string">'\0'</span>) <span class="hljs-keyword">break</span>;
      uVar10 = uVar10 + <span class="hljs-number">1</span>;
    } <span class="hljs-keyword">while</span> (uVar10 &lt; <span class="hljs-number">0x400</span>);
    <span class="hljs-keyword">if</span> (uVar10 &lt; <span class="hljs-number">2</span>) <span class="hljs-keyword">goto</span> LAB_8000b2cb;
    uVar10 = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">do</span> {
      <span class="hljs-keyword">if</span> (pcVar11[uVar10] == <span class="hljs-string">'\0'</span>) <span class="hljs-keyword">break</span>;
      uVar10 = uVar10 + <span class="hljs-number">1</span>;
    } <span class="hljs-keyword">while</span> (uVar10 &lt; <span class="hljs-number">0x400</span>);
    <span class="hljs-keyword">if</span> ((pcVar11[uVar10 - <span class="hljs-number">1</span>] == <span class="hljs-string">'/'</span>) || (*pcVar11 == <span class="hljs-string">'.'</span>)) <span class="hljs-keyword">goto</span> LAB_8000b2cb;
  }
  <span class="hljs-keyword">if</span> ((longlong)EVar8 &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> EVar8;
  }
  uVar14 = uVar14 + <span class="hljs-number">1</span>;
  lVar13 = lVar13 + <span class="hljs-number">0x28</span>;
  <span class="hljs-keyword">if</span> ((ulonglong)param_4[<span class="hljs-number">3</span>] &lt;= uVar14) {
    <span class="hljs-keyword">return</span> EVar8;
  }
  <span class="hljs-keyword">goto</span> LAB_8000aedf;
}
</div></code></pre>
<p>This function exists at <code>0x8000AD9C</code> in <code>1.8.1</code>.</p>
<p>This looks like a function that validates URLs.  A few more interesting details about this function include it seems to have a file signing check implemented, so perhaps the vendor added something like an HMAC to the metadata file for verification. It also looks like this function references the CA-cert bundle for hostname verification.</p>
<p>The big test is though if this function exists within the <code>1.7.1</code> image.  If no corresponding code is found in <code>1.7.1</code> then the aforementioned function is more likely to be part of the fix. Using <a href="https://www.zynamics.com/bindiff.html">bindiff</a>, we see that the function at this address is unmatched in version <code>1.7.1</code>.</p>
<p><img src="images/0054/bindiff-unmatched.PNG" alt="Bindiff Unmatched" title="Bindiff Unmatched Screenshot"></p>
<p>I am confident the new function represents the bulk of the verification that fixes this vulnerability.  The new function is called through an intermediary function from the function at <code>0x80007e9c</code> (<code>1.7.1</code>) and <code>0x80001be0</code> (<code>1.8.1</code>).  This function exists in both images and changes significantly from <code>1.7.1</code> to <code>1.8.1</code>.</p>
<p><img src="images/0054/bindiff-matched.PNG" alt="Bindiff Matched" title="Bindiff Matched Screenshot"></p>
<p><a href="/">Back</a></p>

</body>
</html>
